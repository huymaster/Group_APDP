@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using WebApp.Core
@using WebApp.Data
@model Course
@inject IAuthorizationService auth
@inject ApplicationIdentityDbContext ctx
@inject UserManager<User> UserManager

@{
    var manageCourse = await auth.AuthorizeAsync(User, null, Policies.CanManageCourses);
    var assignStudent = await auth.AuthorizeAsync(User, null, Policies.CanAssignStudents);
    var user = await UserManager.GetUserAsync(User);
    ViewBag.HasManageCourse = manageCourse.Succeeded;
    ViewBag.HasAssignStudent = assignStudent.Succeeded;
    ViewBag.CanAssignThisCourse = Model.TeacherId == user?.Id;
    var detailsUrl = Url.Action("Details", "Courses", new { id = Model.CourseId });
}

<div id="card-@Model.CourseId" class="card course-card" style="cursor: pointer" data-details-url="@detailsUrl">
    <div class="card-body d-inline-flex">
        <div class="flex-grow-1">
            <h5 class="card-title">@Model.CourseName (@Model.CourseCode)</h5>
            <p class="card-text">@(Model.Description ?? "<No description>")</p>
            <p class="card-text">Assigned to: @(Model.Teacher?.FullName ?? "<no teacher>")</p>
            <p class="card-text">Enrolled students: @Model.AssignedUsers.Count()</p>
            <div class="row mt-3">
                <p class="col card-text me-1">From: @Model.StartDate.ToString("dd/MM/yyyy")</p>
                <p class="col card-text me-1">To: @Model.EndDate.ToString("dd/MM/yyyy")</p>
            </div>
        </div>
        <div class="d-flex flex-column">
            @if (ViewBag.HasAssignStudent)
            {
                @if (ViewBag.CanAssignThisCourse || ViewBag.HasManageCourse)
                {
                    <a class="btn btn-primary m-1" asp-area=""
                       asp-controller="Enrollments"
                       asp-action="Enroll"
                       asp-route-courseId="@Model.CourseId"
                       asp-route-returnUrl="@Context.Request.Path">
                        Enroll
                    </a>
                }
                else
                {
                    <a class="btn btn-primary m-1 disabled" asp-area="">
                        Enroll
                    </a>
                }
            }
            @if (ViewBag.HasManageCourse)
            {
                <a class="btn btn-primary m-1" asp-area=""
                   asp-controller="Courses"
                   asp-action="Edit"
                   asp-route-id="@Model.CourseId">
                    Edit
                </a>
                <button class="btn btn-danger m-1"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteCourseModal"
                        data-id="@Model.CourseId">
                    Delete
                </button>
            }
        </div>
    </div>
</div>